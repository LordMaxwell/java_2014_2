package br.com.stefanini.treinamento.boleto;

import java.math.BigDecimal;
import java.math.RoundingMode;
import java.util.Date;

import br.com.stefanini.treinamento.exception.ManagerException;

public abstract class BloquetoBBImpl implements BloquetoBB {

	protected String codigoBanco;
	protected String codigoMoeda;
	protected String fatorVencimento;
	protected Date dataVencimento;
	protected Date dataBase;
	protected BigDecimal valor;
	protected String numeroConvenioBanco;
	protected String complementoNumeroConvenioBancoSemDV;
	protected String numeroAgenciaRelacionamento;
	protected String contaCorrenteRelacionamentoSemDV;
	protected String tipoCarteira;

	private int dvCodigoBarras;

	protected abstract void validaDados() throws ManagerException;

	/**
	 * Inicializa o fator de vencimento
	 */
	protected void setFatorVencimento() {

		long dias = diferencaEmDias(dataBase, dataVencimento);

		/*
		 * Este método recebe o valor da diferença em dias
		 * da data base com a data do vencimento e armazena 
		 * na variável fator vencimento no formato adequado.
		 */

		fatorVencimento = String.format("%04d", dias);

	}

	/**
	 * Inicializa os valores, formata
	 */
	protected void init() {

		setFatorVencimento();

	}

	/**
	 * Retorna o valor formatado do boleto bancário
	 * 
	 * @return
	 */
	protected String getValorFormatado() {
		/*
		 * O método retorna o valor armazenado em "value" no formato adequado,
		 * sendo este formato apresentando apenas algarismos, sem ponto, 
		 * com 10 casas obrigatoriamente, completadas com zeros não significativos
		 * caso necessário, e com duas casas depois da vírgula, 
		 * sendo arredondado para cima caso hajam mais casas. 
		 */

		return String.format(
				"%010d",
				Long.valueOf(valor.setScale(2, RoundingMode.HALF_UP).toString()
						.replace(".", "")));
	}

	/**
	 * Formata o número do convênio da Linha Digitável
	 * 
	 * @return
	 */
	protected abstract String getLDNumeroConvenio();

	/**
	 * Retorna o código de barras do Bloqueto
	 * 
	 * @return código de barras
	 */
	protected abstract String getCodigoBarrasSemDigito();

	public abstract String getCodigoBarras();

	/**
	 * Campo 5 da Linha Digitável
	 * 
	 * @return
	 */
	private String ldCampo5() {
		StringBuilder buffer = new StringBuilder();
		buffer.append(fatorVencimento);
		buffer.append(getValorFormatado());
		return buffer.toString();
	}

	/**
	 * Campo 4 da Linha Digitável
	 * 
	 * @return
	 */
	private String ldCampo4() {
		return String.valueOf(digitoVerificadorCodigoBarras(getCodigoBarrasSemDigito()));
	}

	/**
	 * Campo 3 da Linha Digitável
	 * 
	 * @return
	 */
	private String ldCampo3() {
		return String.format("%s.%s", getCodigoBarras().substring(34, 39), getCodigoBarras().substring(39, 44));
	}

	/**
	 * Campo 2 da Linha Digitável
	 * 
	 * @return
	 */
	private String ldCampo2() {
		return String.format("%s.%s", getCodigoBarras().substring(24, 29), getCodigoBarras().substring(29, 34));
	}

	/**
	 * Calcula o digito verificador do campo
	 * 
	 * @param campo
	 * @return
	 */
	protected int digitoVerificadorPorCampo(String campo) {
		int soma = 0;
		int parcial = 0;
		boolean alt = true;
		for (int i = campo.length()-1; i >= 0; i--) {
			if(alt){
				parcial = Integer.parseInt(campo.substring(i)) * 2;
				while(parcial >= 10){
						parcial = (parcial % 10)+((int)(parcial / 10));
				}
			}else{
				parcial = Integer.parseInt(campo.substring(i-1 , i));
			}
			alt = !alt;
			soma += parcial;
		}
		if((10 - (soma % 10)) == 10){
			return 0;
		}else{
			return 10 - (soma % 10);
		}
	}

	/**
	 * Calcula o digito verificado do código de barras
	 * 
	 * @param codigoBarras
	 * @return
	 */
	protected int digitoVerificadorCodigoBarras(String codigoBarras) {
		int i = codigoBarras.length();
		int k = 2;
		int soma = 0;
		
		while(i != 0){
		
			if (k == 10){
				k = 2;
			}
			soma += Integer.parseInt(codigoBarras.substring(i-1 , i)) * k;
			k++;
			i--;
		}
		soma = soma%11;
		soma = 11 - soma;

		if ((soma <= 0) || (soma == 10) || (soma == 11)){
			return 1;
		}else{
			return soma;
		}
	}

	/**
	 * Campo 1 da Linha Digitável
	 * 
	 * - Código do Banco - Código da Moeda - Número do convênio
	 * 
	 * @return
	 */
	private String ldCampo1() {
		StringBuilder buffer = new StringBuilder();
		
		buffer.append(codigoBanco);
		buffer.append(codigoMoeda);
		buffer.append(getLDNumeroConvenio());
		
		return buffer.toString();

	}

	public String getLinhaDigitavel() {

		init();

		StringBuilder buffer = new StringBuilder();
		buffer.append(ldCampo1());
		buffer.append(digitoVerificadorPorCampo(ldCampo1()));
		buffer.append(" ");
		
		buffer.append(ldCampo2());
		buffer.append(digitoVerificadorPorCampo(ldCampo2()));
		buffer.append(" ");
		buffer.append(ldCampo3());
		buffer.append(digitoVerificadorPorCampo(ldCampo3()));
		buffer.append(" ");
		buffer.append(ldCampo4());
		buffer.append(" ");
		buffer.append(ldCampo5());
		
		return buffer.toString();
	}

	/**
	 * Retorna a diferença em dias de duas datas
	 * 
	 * @param dataInicial
	 *            Data inicial
	 * @param dataFinal
	 *            Data final
	 * @return
	 */
	protected static long diferencaEmDias(Date dataInicial, Date dataFinal) {
		/*
		 * Retorna um long arredondado para cima da diferença 
		 * entre as duas datas do parâmetro, a final menos a inicial, 
		 * e divide pela quantidade de milissegundos de um dia, 
		 * retornando assim, a quantidade da diferença em dias 
		 * entre as duas datas.
		 */		
		return Math
				.round((dataFinal.getTime() - dataInicial.getTime()) / 86400000D);
	}

	public int getDvCodigoBarras() {

		getCodigoBarras();

		return dvCodigoBarras;
	}
}
